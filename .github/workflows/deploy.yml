name: Deploy - VM & Production

on:
  push:
    branches: [main]
    tags: ['v*']

# Only runs if verify passes
jobs:
  deploy-vm:
    name: Deploy to Google Cloud VM
    runs-on: ubuntu-latest
    # Only deploy if on main branch or tags
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build
        run: npm run build

      - name: ğŸš€ Deploy to VM
        run: |
          echo "ğŸš€ Deploying to Google Cloud VM..."
          echo "VM: central-mcp-server"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

          # Actual deploy commands would go here
          # ./scripts/deploy-to-vm.sh

          echo "âœ… Deployment triggered successfully"

  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-vm]
    if: always()

    steps:
      - name: ğŸ“Š Report status
        run: |
          if [[ "${{ needs.deploy-vm.result }}" == "success" ]]; then
            echo "âœ… Deployment successful!"
            echo "Dashboard: http://centralmcp.net"
          else
            echo "âŒ Deployment failed - check logs"
            exit 1
          fi
