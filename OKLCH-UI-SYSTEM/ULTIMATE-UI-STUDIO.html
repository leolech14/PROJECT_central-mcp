<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎨 Ultimate UI Studio - Central-MCP Design System Builder</title>

    <!-- Import Maps for OKLCH 3D -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/"
        }
    }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Active color groups */
            --primary: oklch(0.60 0.18 270);
            --secondary: oklch(0.65 0.15 210);
            --accent: oklch(0.75 0.15 85);
            --background: oklch(0.98 0.01 270);
            --surface: oklch(1.00 0.00 270);
            --text: oklch(0.15 0.02 270);
            --text-secondary: oklch(0.45 0.02 270);
            --border: oklch(0.88 0.01 270);
            --success: oklch(0.65 0.18 145);
            --warning: oklch(0.70 0.18 70);
            --error: oklch(0.60 0.20 25);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
            background: oklch(0.12 0.01 270);
            color: oklch(0.95 0.01 270);
            overflow: hidden;
        }

        /* ========== MAIN LAYOUT ========== */
        .studio {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
        }

        /* ========== TOP BAR ========== */
        .top-bar {
            grid-column: 1 / -1;
            background: oklch(0.15 0.01 270);
            border-bottom: 1px solid oklch(0.25 0.01 270);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .studio-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mode-toggle {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: oklch(0.18 0.01 270);
            border-radius: 8px;
        }

        .mode-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: oklch(0.70 0.01 270);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 150ms;
        }

        .mode-btn.active {
            background: oklch(0.60 0.18 270);
            color: white;
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .top-btn {
            padding: 8px 16px;
            background: oklch(0.18 0.01 270);
            border: 1px solid oklch(0.28 0.01 270);
            border-radius: 8px;
            color: oklch(0.95 0.01 270);
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 150ms;
        }

        .top-btn:hover {
            background: oklch(0.22 0.01 270);
            border-color: oklch(0.38 0.02 270);
        }

        .top-btn-primary {
            background: oklch(0.60 0.18 270);
            border-color: oklch(0.60 0.18 270);
            color: white;
        }

        .top-btn-primary:hover {
            background: oklch(0.65 0.18 270);
        }

        /* ========== LEFT PANEL: COLOR CONTROLS + GROUPING ========== */
        .left-panel {
            background: oklch(0.15 0.01 270);
            border-right: 1px solid oklch(0.25 0.01 270);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid oklch(0.25 0.01 270);
        }

        .panel-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: oklch(0.70 0.01 270);
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 150ms;
        }

        .panel-tab.active {
            color: oklch(0.95 0.01 270);
            border-bottom-color: oklch(0.60 0.18 270);
            background: oklch(0.18 0.01 270);
        }

        .tab-content {
            flex: 1;
            padding: 24px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Color Group Controls */
        .color-group {
            background: oklch(0.18 0.01 270);
            border: 1px solid oklch(0.28 0.01 270);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .group-name {
            font-weight: 600;
            font-size: 15px;
        }

        .group-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            background: oklch(0.60 0.18 270);
            color: white;
            font-weight: 500;
        }

        .color-preview {
            width: 100%;
            height: 48px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 2px solid oklch(0.28 0.01 270);
            cursor: pointer;
            transition: all 150ms;
        }

        .color-preview:hover {
            border-color: oklch(0.60 0.18 270);
            transform: scale(1.02);
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 12px;
            font-weight: 600;
            width: 16px;
            color: oklch(0.70 0.01 270);
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: oklch(0.25 0.01 270);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: oklch(0.65 0.18 270);
            cursor: pointer;
            border: 2px solid white;
        }

        .slider-value {
            font-size: 12px;
            font-family: 'SF Mono', monospace;
            width: 48px;
            text-align: right;
            color: oklch(0.70 0.01 270);
        }

        /* Component Grouping System */
        .grouping-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: oklch(0.85 0.01 270);
        }

        .component-group {
            background: oklch(0.18 0.01 270);
            border: 2px dashed oklch(0.28 0.01 270);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            min-height: 80px;
        }

        .component-tag {
            display: inline-block;
            padding: 4px 12px;
            margin: 4px;
            background: oklch(0.25 0.01 270);
            border: 1px solid oklch(0.35 0.01 270);
            border-radius: 6px;
            font-size: 12px;
            cursor: move;
            transition: all 150ms;
            user-select: none;
        }

        .component-tag:hover {
            background: oklch(0.30 0.01 270);
            border-color: oklch(0.60 0.18 270);
        }

        .component-tag.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .component-group.drag-over {
            background: oklch(0.22 0.01 270);
            border-color: oklch(0.60 0.18 270);
            border-style: solid;
        }

        /* Relationship Rules */
        .rule-card {
            background: oklch(0.18 0.01 270);
            border: 1px solid oklch(0.28 0.01 270);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .rule-title {
            font-size: 13px;
            font-weight: 600;
        }

        .rule-type {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            background: oklch(0.25 0.01 270);
        }

        .rule-formula {
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            color: oklch(0.70 0.01 270);
            margin-top: 8px;
        }

        /* ========== CENTER PANEL: COMPONENT GALLERY ========== */
        .center-panel {
            background: var(--background);
            overflow-y: auto;
            padding: 48px;
            transition: all 250ms;
        }

        .gallery-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .gallery-title {
            font-size: 36px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }

        .gallery-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .component-section {
            margin-bottom: 64px;
        }

        .section-header {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        /* Button Components */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid transparent;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 250ms;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: oklch(from var(--primary) calc(l + 0.1) c h);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px oklch(from var(--primary) l c h / 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: oklch(from var(--secondary) calc(l + 0.1) c h);
        }

        .btn-outline {
            background: transparent;
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text);
        }

        .btn-ghost:hover {
            background: oklch(from var(--primary) l c h / 0.1);
            color: var(--primary);
        }

        /* Input Components */
        .input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            margin-bottom: 12px;
            transition: all 250ms;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px oklch(from var(--primary) l c h / 0.2);
        }

        .input::placeholder {
            color: var(--text-secondary);
        }

        /* Card Components */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px oklch(0.15 0 0 / 0.1);
            transition: all 250ms;
        }

        .card:hover {
            box-shadow: 0 4px 6px oklch(0.15 0 0 / 0.1);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .card-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Badge Components */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
        }

        .badge-primary {
            background: oklch(from var(--primary) l c h / 0.2);
            color: var(--primary);
        }

        .badge-success {
            background: oklch(from var(--success) l c h / 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: oklch(from var(--warning) l c h / 0.2);
            color: var(--warning);
        }

        .badge-error {
            background: oklch(from var(--error) l c h / 0.2);
            color: var(--error);
        }

        /* Alert Components */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: oklch(from var(--success) l c h / 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-warning {
            background: oklch(from var(--warning) l c h / 0.15);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .alert-error {
            background: oklch(from var(--error) l c h / 0.15);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Navigation Components */
        .nav {
            display: flex;
            gap: 4px;
            padding: 8px;
            background: var(--surface);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .nav-item {
            padding: 8px 16px;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 150ms;
        }

        .nav-item:hover {
            background: oklch(from var(--primary) l c h / 0.1);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        /* Table Components */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .table th {
            background: oklch(from var(--background) calc(l - 0.03) c h);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 12px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table tr:hover {
            background: oklch(from var(--background) calc(l - 0.01) c h);
        }

        /* Form Components */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin: 8px 0;
        }

        .checkbox input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* ========== RIGHT PANEL: OKLCH TOOLS + BLUEPRINT ========== */
        .right-panel {
            background: oklch(0.15 0.01 270);
            border-left: 1px solid oklch(0.25 0.01 270);
            overflow-y: auto;
            padding: 24px;
        }

        .tool-section {
            margin-bottom: 32px;
        }

        .tool-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: oklch(0.95 0.01 270);
        }

        /* Mini OKLCH Pickers */
        .oklch-picker {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid oklch(0.28 0.01 270);
            margin-bottom: 16px;
            cursor: pointer;
        }

        /* 3D Viewer Container */
        #oklch-3d-viewer {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            border: 2px solid oklch(0.28 0.01 270);
            margin-bottom: 16px;
        }

        /* Theme Blueprint */
        .blueprint-card {
            background: oklch(0.18 0.01 270);
            border: 1px solid oklch(0.28 0.01 270);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .blueprint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .blueprint-name {
            font-weight: 600;
            font-size: 14px;
        }

        .weight-bar {
            height: 8px;
            background: oklch(0.25 0.01 270);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .weight-fill {
            height: 100%;
            background: var(--primary);
            transition: width 250ms;
        }

        .weight-label {
            font-size: 12px;
            color: oklch(0.70 0.01 270);
            display: flex;
            justify-content: space-between;
        }

        /* Safe Zone Indicator */
        .zone-indicator {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .zone-safe {
            background: oklch(from var(--success) l c h / 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .zone-warning {
            background: oklch(from var(--warning) l c h / 0.2);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .zone-danger {
            background: oklch(from var(--error) l c h / 0.2);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: oklch(0.20 0.01 270);
        }

        ::-webkit-scrollbar-thumb {
            background: oklch(0.35 0.01 270);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: oklch(0.45 0.01 270);
        }

        /* Rule Builder Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: oklch(0.10 0.01 270 / 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: oklch(0.15 0.01 270);
            border: 1px solid oklch(0.28 0.01 270);
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px oklch(0.05 0 0 / 0.5);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: oklch(0.18 0.01 270);
            border: 1px solid oklch(0.28 0.01 270);
            border-radius: 8px;
            color: oklch(0.95 0.01 270);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: oklch(0.60 0.18 270);
        }

        select.form-input {
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .safe-zone-details {
            font-size: 11px;
            margin-top: 8px;
            padding: 8px;
            background: oklch(0.18 0.01 270);
            border-radius: 4px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="studio">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="studio-title">
                🎨 Ultimate UI Studio
                <span style="font-size: 12px; font-weight: 400; opacity: 0.7;">
                    Central-MCP Design System Builder
                </span>
            </div>

            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="light">☀️ Light</button>
                <button class="mode-btn" data-mode="dark">🌙 Dark</button>
            </div>

            <div class="action-btns">
                <button class="top-btn" onclick="loadBlueprint()">📂 Load</button>
                <button class="top-btn" onclick="saveBlueprint()">💾 Save</button>
                <button class="top-btn" onclick="exportTheme()">📥 Export</button>
                <button class="top-btn top-btn-primary" onclick="applyToEcosystem()">🚀 Apply to Ecosystem</button>
            </div>
        </div>

        <!-- LEFT PANEL: COLOR CONTROLS + GROUPING -->
        <div class="left-panel">
            <div class="panel-tabs">
                <button class="panel-tab active" data-tab="colors">🎨 Colors</button>
                <button class="panel-tab" data-tab="groups">📦 Groups</button>
                <button class="panel-tab" data-tab="rules">🔗 Rules</button>
            </div>

            <!-- COLORS TAB -->
            <div class="tab-content active" id="colors-tab">
                <div class="color-group">
                    <div class="group-header">
                        <span class="group-name">Primary</span>
                        <span class="group-badge">BRAND</span>
                    </div>
                    <div class="color-preview" id="primary-preview" style="background: var(--primary);"></div>
                    <div class="slider-row">
                        <span class="slider-label">L</span>
                        <input type="range" id="primary-l" min="0" max="100" value="60" step="1">
                        <span class="slider-value" id="primary-l-val">0.60</span>
                    </div>
                    <div class="slider-row">
                        <span class="slider-label">C</span>
                        <input type="range" id="primary-c" min="0" max="37" value="18" step="1">
                        <span class="slider-value" id="primary-c-val">0.18</span>
                    </div>
                    <div class="slider-row">
                        <span class="slider-label">H</span>
                        <input type="range" id="primary-h" min="0" max="360" value="270" step="1">
                        <span class="slider-value" id="primary-h-val">270</span>
                    </div>
                </div>

                <div class="color-group">
                    <div class="group-header">
                        <span class="group-name">Secondary</span>
                        <span class="group-badge">ACCENT</span>
                    </div>
                    <div class="color-preview" id="secondary-preview" style="background: var(--secondary);"></div>
                    <div class="slider-row">
                        <span class="slider-label">L</span>
                        <input type="range" id="secondary-l" min="0" max="100" value="65" step="1">
                        <span class="slider-value" id="secondary-l-val">0.65</span>
                    </div>
                    <div class="slider-row">
                        <span class="slider-label">C</span>
                        <input type="range" id="secondary-c" min="0" max="37" value="15" step="1">
                        <span class="slider-value" id="secondary-c-val">0.15</span>
                    </div>
                    <div class="slider-row">
                        <span class="slider-label">H</span>
                        <input type="range" id="secondary-h" min="0" max="360" value="210" step="1">
                        <span class="slider-value" id="secondary-h-val">210</span>
                    </div>
                </div>

                <div class="color-group">
                    <div class="group-header">
                        <span class="group-name">Accent</span>
                        <span class="group-badge">HIGHLIGHT</span>
                    </div>
                    <div class="color-preview" id="accent-preview" style="background: var(--accent);"></div>
                    <div class="slider-row">
                        <span class="slider-label">L</span>
                        <input type="range" id="accent-l" min="0" max="100" value="75" step="1">
                        <span class="slider-value" id="accent-l-val">0.75</span>
                    </div>
                    <div class="slider-row">
                        <span class="slider-label">C</span>
                        <input type="range" id="accent-c" min="0" max="37" value="15" step="1">
                        <span class="slider-value" id="accent-c-val">0.15</span>
                    </div>
                    <div class="slider-row">
                        <span class="slider-label">H</span>
                        <input type="range" id="accent-h" min="0" max="360" value="85" step="1">
                        <span class="slider-value" id="accent-h-val">85</span>
                    </div>
                </div>
            </div>

            <!-- GROUPS TAB -->
            <div class="tab-content" id="groups-tab">
                <div class="grouping-section">
                    <div class="section-title">Primary Group</div>
                    <div class="component-group" data-group="primary">
                        <div class="component-tag">Primary Buttons</div>
                        <div class="component-tag">CTA Cards</div>
                        <div class="component-tag">Links</div>
                    </div>
                </div>

                <div class="grouping-section">
                    <div class="section-title">Secondary Group</div>
                    <div class="component-group" data-group="secondary">
                        <div class="component-tag">Secondary Buttons</div>
                        <div class="component-tag">Table Headers</div>
                    </div>
                </div>

                <div class="grouping-section">
                    <div class="section-title">Accent Group</div>
                    <div class="component-group" data-group="accent">
                        <div class="component-tag">Badges</div>
                        <div class="component-tag">Notifications</div>
                        <div class="component-tag">Highlights</div>
                    </div>
                </div>

                <div class="grouping-section">
                    <div class="section-title">Unassigned Components</div>
                    <div class="component-group" data-group="unassigned">
                        <div class="component-tag">Alerts</div>
                        <div class="component-tag">Progress Bars</div>
                        <div class="component-tag">Tooltips</div>
                    </div>
                </div>
            </div>

            <!-- RULES TAB -->
            <div class="tab-content" id="rules-tab">
                <div class="rule-card">
                    <div class="rule-header">
                        <span class="rule-title">Primary → Secondary</span>
                        <span class="rule-type">Analogous</span>
                    </div>
                    <div class="rule-formula">H: +60° | C: ×0.85 | L: -0.05</div>
                </div>

                <div class="rule-card">
                    <div class="rule-header">
                        <span class="rule-title">Primary → Accent</span>
                        <span class="rule-type">Split</span>
                    </div>
                    <div class="rule-formula">H: -30° | C: ×0.75 | L: +0.10</div>
                </div>

                <div class="rule-card">
                    <div class="rule-header">
                        <span class="rule-title">Background ↔ Text</span>
                        <span class="rule-type">Contrast</span>
                    </div>
                    <div class="rule-formula">Ensure 4.5:1 ratio | Opposite direction</div>
                </div>

                <button class="top-btn" style="width: 100%; margin-top: 16px;" onclick="openRuleBuilder()">➕ Add New Rule</button>
            </div>
        </div>

        <!-- CENTER PANEL: COMPREHENSIVE COMPONENT GALLERY -->
        <div class="center-panel">
            <div class="gallery-header">
                <div class="gallery-title">Component Gallery</div>
                <div class="gallery-subtitle">Live preview of all UI elements with current theme</div>
            </div>

            <!-- BUTTONS SECTION -->
            <div class="component-section">
                <div class="section-header">Buttons</div>
                <div>
                    <button class="btn btn-primary">Primary Button</button>
                    <button class="btn btn-secondary">Secondary Button</button>
                    <button class="btn btn-outline">Outline Button</button>
                    <button class="btn btn-ghost">Ghost Button</button>
                </div>
            </div>

            <!-- INPUTS SECTION -->
            <div class="component-section">
                <div class="section-header">Form Inputs</div>
                <input type="text" class="input" placeholder="Enter your text...">
                <input type="email" class="input" placeholder="email@example.com">
                <input type="search" class="input" placeholder="Search...">
            </div>

            <!-- CARDS SECTION -->
            <div class="component-section">
                <div class="section-header">Cards</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                    <div class="card">
                        <div class="card-title">Feature Card</div>
                        <div class="card-text">This is a preview of how cards look with the current theme.</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Another Card</div>
                        <div class="card-text">Cards automatically adapt to your color scheme.</div>
                    </div>
                </div>
            </div>

            <!-- BADGES SECTION -->
            <div class="component-section">
                <div class="section-header">Badges</div>
                <span class="badge badge-primary">Primary</span>
                <span class="badge badge-success">Success</span>
                <span class="badge badge-warning">Warning</span>
                <span class="badge badge-error">Error</span>
            </div>

            <!-- ALERTS SECTION -->
            <div class="component-section">
                <div class="section-header">Alerts</div>
                <div class="alert alert-success">
                    <span>✓</span>
                    <span>Success! Your changes have been saved.</span>
                </div>
                <div class="alert alert-warning">
                    <span>⚠</span>
                    <span>Warning: Please review your input.</span>
                </div>
                <div class="alert alert-error">
                    <span>✕</span>
                    <span>Error: Something went wrong.</span>
                </div>
            </div>

            <!-- NAVIGATION SECTION -->
            <div class="component-section">
                <div class="section-header">Navigation</div>
                <div class="nav">
                    <div class="nav-item active">Dashboard</div>
                    <div class="nav-item">Projects</div>
                    <div class="nav-item">Settings</div>
                    <div class="nav-item">Help</div>
                </div>
            </div>

            <!-- TABLE SECTION -->
            <div class="component-section">
                <div class="section-header">Tables</div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Project Alpha</td>
                            <td><span class="badge badge-success">Active</span></td>
                            <td>2025-10-11</td>
                        </tr>
                        <tr>
                            <td>Project Beta</td>
                            <td><span class="badge badge-warning">Pending</span></td>
                            <td>2025-10-10</td>
                        </tr>
                        <tr>
                            <td>Project Gamma</td>
                            <td><span class="badge badge-primary">In Review</span></td>
                            <td>2025-10-09</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- FORMS SECTION -->
            <div class="component-section">
                <div class="section-header">Form Elements</div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="input" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Preferences</label>
                    <div class="checkbox">
                        <input type="checkbox" checked>
                        <span>Enable notifications</span>
                    </div>
                    <div class="checkbox">
                        <input type="checkbox">
                        <span>Subscribe to newsletter</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: OKLCH TOOLS + BLUEPRINT -->
        <div class="right-panel">
            <!-- 2D OKLCH Pickers -->
            <div class="tool-section">
                <div class="tool-title">🎨 2D Color Pickers</div>

                <!-- Hue Wheel -->
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; margin-bottom: 8px; color: oklch(0.70 0.01 270);">Hue Wheel</div>
                    <canvas id="hue-wheel" class="oklch-picker" width="300" height="300"></canvas>
                </div>

                <!-- Chroma-Lightness Selector -->
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; margin-bottom: 8px; color: oklch(0.70 0.01 270);">Chroma × Lightness</div>
                    <canvas id="chroma-lightness" class="oklch-picker" width="300" height="300"></canvas>
                </div>
            </div>

            <!-- OKLCH 3D Viewer -->
            <div class="tool-section">
                <div class="tool-title">🎮 OKLCH 3D Space</div>
                <div id="oklch-3d-viewer"></div>
            </div>

            <!-- Safe Zone Indicator -->
            <div class="tool-section">
                <div class="tool-title">🎯 Safe Zone Status</div>
                <div class="zone-indicator zone-safe">
                    <span>✓</span>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">All Safe</div>
                        <div style="font-size: 11px; opacity: 0.8;">WCAG 2.2 AA compliant</div>
                    </div>
                </div>
            </div>

            <!-- Theme Blueprint -->
            <div class="tool-section">
                <div class="tool-title">📊 Theme Blueprint</div>

                <div class="blueprint-card">
                    <div class="blueprint-header">
                        <span class="blueprint-name">Primary</span>
                        <span style="font-size: 12px; color: oklch(0.70 0.01 270);">60%</span>
                    </div>
                    <div class="weight-bar">
                        <div class="weight-fill" style="width: 60%;"></div>
                    </div>
                    <div class="weight-label">
                        <span>Usage</span>
                        <span>High</span>
                    </div>
                </div>

                <div class="blueprint-card">
                    <div class="blueprint-header">
                        <span class="blueprint-name">Secondary</span>
                        <span style="font-size: 12px; color: oklch(0.70 0.01 270);">30%</span>
                    </div>
                    <div class="weight-bar">
                        <div class="weight-fill" style="width: 30%;"></div>
                    </div>
                    <div class="weight-label">
                        <span>Usage</span>
                        <span>Medium</span>
                    </div>
                </div>

                <div class="blueprint-card">
                    <div class="blueprint-header">
                        <span class="blueprint-name">Accent</span>
                        <span style="font-size: 12px; color: oklch(0.70 0.01 270);">10%</span>
                    </div>
                    <div class="weight-bar">
                        <div class="weight-fill" style="width: 10%;"></div>
                    </div>
                    <div class="weight-label">
                        <span>Usage</span>
                        <span>Low</span>
                    </div>
                </div>
            </div>

            <!-- Relationship Visualization -->
            <div class="tool-section">
                <div class="tool-title">🔗 Color Relationships</div>
                <div style="background: oklch(0.18 0.01 270); border-radius: 8px; padding: 16px; font-family: 'SF Mono', monospace; font-size: 12px; line-height: 1.8;">
                    <div>Primary → Secondary (+60°)</div>
                    <div>Primary → Accent (-30°)</div>
                    <div>Background ↔ Text (4.5:1)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rule Builder Modal -->
    <div class="modal-overlay" id="rule-builder-modal">
        <div class="modal">
            <div class="modal-title">➕ Create New Color Rule</div>

            <div>
                <label style="display: block; font-size: 12px; margin-bottom: 8px; color: oklch(0.70 0.01 270);">Source Group</label>
                <select class="form-input" id="rule-source">
                    <option value="primary">Primary</option>
                    <option value="secondary">Secondary</option>
                    <option value="accent">Accent</option>
                    <option value="background">Background</option>
                    <option value="text">Text</option>
                </select>
            </div>

            <div>
                <label style="display: block; font-size: 12px; margin-bottom: 8px; color: oklch(0.70 0.01 270);">Target Group</label>
                <select class="form-input" id="rule-target">
                    <option value="primary">Primary</option>
                    <option value="secondary">Secondary</option>
                    <option value="accent">Accent</option>
                    <option value="background">Background</option>
                    <option value="text">Text</option>
                </select>
            </div>

            <div>
                <label style="display: block; font-size: 12px; margin-bottom: 8px; color: oklch(0.70 0.01 270);">Relationship Type</label>
                <select class="form-input" id="rule-type">
                    <option value="analogous">Analogous (+60°)</option>
                    <option value="complementary">Complementary (180°)</option>
                    <option value="triadic">Triadic (+120°)</option>
                    <option value="split">Split Complementary (-30°)</option>
                    <option value="contrast">High Contrast</option>
                    <option value="custom">Custom Formula</option>
                </select>
            </div>

            <div id="custom-formula-section" style="display: none;">
                <label style="display: block; font-size: 12px; margin-bottom: 8px; color: oklch(0.70 0.01 270);">Custom Formula</label>
                <input type="text" class="form-input" id="rule-formula" placeholder="H: +60° | C: ×0.85 | L: -0.05">
            </div>

            <div class="modal-actions">
                <button class="top-btn" onclick="closeRuleBuilder()">Cancel</button>
                <button class="top-btn top-btn-primary" onclick="createRule()">Create Rule</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Initialize 3D OKLCH viewer
        function init3DViewer() {
            const container = document.getElementById('oklch-3d-viewer');

            // Scene
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a20);

            // Camera
            const camera = new THREE.PerspectiveCamera(
                45,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(2, 2, 3);

            // Renderer
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // Controls
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Create OKLCH space visualization (cylinder)
            const geometry = new THREE.CylinderGeometry(1, 1, 2, 32);
            const material = new THREE.MeshBasicMaterial({
                color: 0x6366f1,
                wireframe: true,
                transparent: true,
                opacity: 0.3
            });
            const cylinder = new THREE.Mesh(geometry, material);
            scene.add(cylinder);

            // Add current color point
            const pointGeometry = new THREE.SphereGeometry(0.05, 16, 16);
            const pointMaterial = new THREE.MeshBasicMaterial({ color: 0xff6600 });
            const point = new THREE.Mesh(pointGeometry, pointMaterial);
            scene.add(point);

            window.updateColorPoint = (l, c, h) => {
                const angle = (h * Math.PI) / 180;
                const x = c * Math.cos(angle);
                const z = c * Math.sin(angle);
                const y = l - 0.5;
                point.position.set(x, y, z);
            };

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }

        // Initialize tabs
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                const tabId = tab.dataset.tab + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Initialize sliders
        const colorGroups = ['primary', 'secondary', 'accent'];
        const components = ['l', 'c', 'h'];

        colorGroups.forEach(group => {
            components.forEach(component => {
                const slider = document.getElementById(`${group}-${component}`);
                const valueDisplay = document.getElementById(`${group}-${component}-val`);

                slider.addEventListener('input', (e) => {
                    let value = parseFloat(e.target.value);
                    let displayValue;

                    if (component === 'l' || component === 'c') {
                        displayValue = (value / 100).toFixed(2);
                        value = value / 100;
                    } else {
                        displayValue = value;
                    }

                    valueDisplay.textContent = displayValue;
                    updateColors(group, component, value);
                });
            });
        });

        function updateColors(group, component, value) {
            const root = document.documentElement;
            const currentColor = getComputedStyle(root).getPropertyValue(`--${group}`);

            // Parse OKLCH
            const match = currentColor.match(/oklch\(([\d.]+)\s+([\d.]+)\s+([\d.]+)\)/);
            if (!match) return;

            let l = parseFloat(match[1]);
            let c = parseFloat(match[2]);
            let h = parseFloat(match[3]);

            // Update component
            if (component === 'l') l = value;
            if (component === 'c') c = value;
            if (component === 'h') h = value;

            // Apply new color
            const newColor = `oklch(${l.toFixed(2)} ${c.toFixed(2)} ${h})`;
            root.style.setProperty(`--${group}`, newColor);

            // Update preview
            const preview = document.getElementById(`${group}-preview`);
            if (preview) preview.style.background = newColor;

            // Update 3D viewer
            if (group === 'primary' && window.updateColorPoint) {
                window.updateColorPoint(l, c, h);
            }
        }

        // Mode toggle
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const mode = btn.dataset.mode;
                toggleMode(mode);
            });
        });

        function toggleMode(mode) {
            const root = document.documentElement;
            if (mode === 'dark') {
                root.style.setProperty('--background', 'oklch(0.15 0.01 270)');
                root.style.setProperty('--surface', 'oklch(0.18 0.01 270)');
                root.style.setProperty('--text', 'oklch(0.95 0.01 270)');
                root.style.setProperty('--text-secondary', 'oklch(0.70 0.01 270)');
                root.style.setProperty('--border', 'oklch(0.28 0.01 270)');
            } else {
                root.style.setProperty('--background', 'oklch(0.98 0.01 270)');
                root.style.setProperty('--surface', 'oklch(1.00 0.00 270)');
                root.style.setProperty('--text', 'oklch(0.15 0.02 270)');
                root.style.setProperty('--text-secondary', 'oklch(0.45 0.02 270)');
                root.style.setProperty('--border', 'oklch(0.88 0.01 270)');
            }
        }

        // Action buttons
        window.saveBlueprint = () => {
            const name = prompt('Enter blueprint name:');
            if (!name) return;

            const blueprint = {
                name,
                colors: {},
                rules: [],
                weights: { primary: 60, secondary: 30, accent: 10 }
            };

            colorGroups.forEach(group => {
                const color = getComputedStyle(document.documentElement).getPropertyValue(`--${group}`);
                blueprint.colors[group] = color;
            });

            const blueprints = JSON.parse(localStorage.getItem('ui-blueprints') || '[]');
            blueprints.push(blueprint);
            localStorage.setItem('ui-blueprints', JSON.stringify(blueprints));

            alert('Blueprint saved successfully!');
        };

        window.loadBlueprint = () => {
            const blueprints = JSON.parse(localStorage.getItem('ui-blueprints') || '[]');
            if (blueprints.length === 0) {
                alert('No saved blueprints found!');
                return;
            }

            const names = blueprints.map((b, i) => `${i + 1}. ${b.name}`).join('\n');
            const choice = prompt(`Select blueprint:\n${names}\n\nEnter number:`);

            if (!choice) return;
            const index = parseInt(choice) - 1;

            if (index >= 0 && index < blueprints.length) {
                const blueprint = blueprints[index];
                const root = document.documentElement;

                Object.entries(blueprint.colors).forEach(([group, color]) => {
                    root.style.setProperty(`--${group}`, color);
                });

                alert('Blueprint loaded successfully!');
            }
        };

        window.exportTheme = () => {
            const theme = {};
            colorGroups.forEach(group => {
                theme[group] = getComputedStyle(document.documentElement).getPropertyValue(`--${group}`);
            });

            const css = Object.entries(theme)
                .map(([k, v]) => `  --${k}: ${v};`)
                .join('\n');

            const output = `:root {\n${css}\n}`;

            navigator.clipboard.writeText(output);
            alert('Theme CSS copied to clipboard!');
        };

        window.applyToEcosystem = () => {
            if (confirm('Apply this theme as the new default for all 60 projects in PROJECTS_all?')) {
                alert('Theme would be applied to ecosystem!\n(Feature in development)');
            }
        };

        // Initialize 3D viewer
        init3DViewer();

        // ========== 2D OKLCH PICKERS ==========

        function init2DPickers() {
            // Hue Wheel
            const hueCanvas = document.getElementById('hue-wheel');
            const hueCtx = hueCanvas.getContext('2d');
            const hueSize = hueCanvas.width;
            const hueCenter = hueSize / 2;
            const hueRadius = hueSize / 2 - 20;

            // Draw hue wheel
            for (let angle = 0; angle < 360; angle += 1) {
                hueCtx.beginPath();
                hueCtx.strokeStyle = `oklch(0.65 0.18 ${angle})`;
                hueCtx.lineWidth = 20;
                const rad = (angle - 90) * Math.PI / 180;
                hueCtx.arc(hueCenter, hueCenter, hueRadius, rad, rad + 0.02);
                hueCtx.stroke();
            }

            // Hue wheel click handler
            hueCanvas.addEventListener('click', (e) => {
                const rect = hueCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left - hueCenter;
                const y = e.clientY - rect.top - hueCenter;
                const angle = (Math.atan2(y, x) * 180 / Math.PI + 90 + 360) % 360;

                // Update primary hue
                document.getElementById('primary-h').value = Math.round(angle);
                document.getElementById('primary-h').dispatchEvent(new Event('input'));
            });

            // Chroma-Lightness Selector
            const clCanvas = document.getElementById('chroma-lightness');
            const clCtx = clCanvas.getContext('2d');
            const clSize = clCanvas.width;

            // Draw chroma-lightness gradient
            const imageData = clCtx.createImageData(clSize, clSize);
            for (let y = 0; y < clSize; y++) {
                for (let x = 0; x < clSize; x++) {
                    const l = 1 - (y / clSize); // Lightness: top = 1, bottom = 0
                    const c = (x / clSize) * 0.37; // Chroma: left = 0, right = 0.37
                    const h = 270; // Use current primary hue

                    // Convert OKLCH to RGB for display
                    const rgb = oklchToRgb(l, c, h);
                    const idx = (y * clSize + x) * 4;
                    imageData.data[idx] = rgb[0];
                    imageData.data[idx + 1] = rgb[1];
                    imageData.data[idx + 2] = rgb[2];
                    imageData.data[idx + 3] = 255;
                }
            }
            clCtx.putImageData(imageData, 0, 0);

            // Chroma-Lightness click handler
            clCanvas.addEventListener('click', (e) => {
                const rect = clCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const l = (1 - (y / clSize)) * 100;
                const c = (x / clSize) * 37;

                document.getElementById('primary-l').value = Math.round(l);
                document.getElementById('primary-c').value = Math.round(c);
                document.getElementById('primary-l').dispatchEvent(new Event('input'));
                document.getElementById('primary-c').dispatchEvent(new Event('input'));
            });
        }

        // Simple OKLCH to RGB conversion (approximate)
        function oklchToRgb(l, c, h) {
            // Simplified conversion for display purposes
            const a = c * Math.cos(h * Math.PI / 180);
            const b = c * Math.sin(h * Math.PI / 180);

            // Convert to RGB (simplified)
            const r = Math.max(0, Math.min(255, Math.round((l + 0.3 * a) * 255)));
            const g = Math.max(0, Math.min(255, Math.round((l - 0.15 * a - 0.2 * b) * 255)));
            const bb = Math.max(0, Math.min(255, Math.round((l + 0.5 * b) * 255)));

            return [r, g, bb];
        }

        // ========== DRAG & DROP FOR COMPONENT GROUPING ==========

        function initDragDrop() {
            const tags = document.querySelectorAll('.component-tag');
            const groups = document.querySelectorAll('.component-group');

            tags.forEach(tag => {
                tag.setAttribute('draggable', 'true');

                tag.addEventListener('dragstart', (e) => {
                    tag.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', tag.innerHTML);
                });

                tag.addEventListener('dragend', () => {
                    tag.classList.remove('dragging');
                });
            });

            groups.forEach(group => {
                group.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    group.classList.add('drag-over');
                });

                group.addEventListener('dragleave', () => {
                    group.classList.remove('drag-over');
                });

                group.addEventListener('drop', (e) => {
                    e.preventDefault();
                    group.classList.remove('drag-over');

                    const draggingTag = document.querySelector('.dragging');
                    if (draggingTag && draggingTag.parentElement !== group) {
                        group.appendChild(draggingTag);
                        console.log(`Moved to ${group.dataset.group} group`);
                    }
                });
            });
        }

        // ========== REAL-TIME SAFE ZONE CALCULATION ==========

        function calculateContrast(color1, color2) {
            // Parse OKLCH colors
            const match1 = color1.match(/oklch\(([\d.]+)\s+([\d.]+)\s+([\d.]+)\)/);
            const match2 = color2.match(/oklch\(([\d.]+)\s+([\d.]+)\s+([\d.]+)\)/);

            if (!match1 || !match2) return 1;

            const l1 = parseFloat(match1[1]);
            const l2 = parseFloat(match2[1]);

            // Approximate relative luminance from lightness
            const lum1 = l1 ** 2.2;
            const lum2 = l2 ** 2.2;

            const lighter = Math.max(lum1, lum2);
            const darker = Math.min(lum1, lum2);

            return (lighter + 0.05) / (darker + 0.05);
        }

        function updateSafeZone() {
            const root = document.documentElement;
            const background = getComputedStyle(root).getPropertyValue('--background');
            const text = getComputedStyle(root).getPropertyValue('--text');
            const primary = getComputedStyle(root).getPropertyValue('--primary');

            const textContrast = calculateContrast(background, text);
            const buttonContrast = calculateContrast(primary, 'oklch(1 0 0)'); // white text on primary

            const indicator = document.querySelector('.zone-indicator');
            const details = document.querySelector('.safe-zone-details');

            let status = 'safe';
            let message = 'All Safe';
            let detailsHtml = `
                <div>✓ Text contrast: ${textContrast.toFixed(2)}:1 (need 4.5:1)</div>
                <div>✓ Button contrast: ${buttonContrast.toFixed(2)}:1 (need 4.5:1)</div>
            `;

            if (textContrast < 4.5 || buttonContrast < 4.5) {
                status = 'warning';
                message = 'Low Contrast Warning';
                detailsHtml = `
                    <div>${textContrast < 4.5 ? '⚠' : '✓'} Text contrast: ${textContrast.toFixed(2)}:1 (need 4.5:1)</div>
                    <div>${buttonContrast < 4.5 ? '⚠' : '✓'} Button contrast: ${buttonContrast.toFixed(2)}:1 (need 4.5:1)</div>
                `;
            }

            if (textContrast < 3.0 || buttonContrast < 3.0) {
                status = 'danger';
                message = 'Contrast Violation!';
                detailsHtml = `
                    <div>${textContrast < 3.0 ? '✕' : '⚠'} Text contrast: ${textContrast.toFixed(2)}:1 (need 4.5:1)</div>
                    <div>${buttonContrast < 3.0 ? '✕' : '⚠'} Button contrast: ${buttonContrast.toFixed(2)}:1 (need 4.5:1)</div>
                `;
            }

            indicator.className = `zone-indicator zone-${status}`;
            indicator.innerHTML = `
                <span>${status === 'safe' ? '✓' : status === 'warning' ? '⚠' : '✕'}</span>
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">${message}</div>
                    <div style="font-size: 11px; opacity: 0.8;">WCAG 2.2 AA ${status === 'safe' ? 'compliant' : 'check required'}</div>
                </div>
            `;

            // Add details if they don't exist
            if (!details) {
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'safe-zone-details';
                detailsDiv.innerHTML = detailsHtml;
                indicator.parentElement.appendChild(detailsDiv);
            } else {
                details.innerHTML = detailsHtml;
            }
        }

        // ========== RULE BUILDER FUNCTIONS ==========

        window.openRuleBuilder = () => {
            document.getElementById('rule-builder-modal').classList.add('active');
        };

        window.closeRuleBuilder = () => {
            document.getElementById('rule-builder-modal').classList.remove('active');
        };

        window.createRule = () => {
            const source = document.getElementById('rule-source').value;
            const target = document.getElementById('rule-target').value;
            const type = document.getElementById('rule-type').value;

            let formula = '';
            switch(type) {
                case 'analogous':
                    formula = 'H: +60° | C: ×0.85 | L: -0.05';
                    break;
                case 'complementary':
                    formula = 'H: +180° | C: ×1.0 | L: same';
                    break;
                case 'triadic':
                    formula = 'H: +120° | C: ×0.9 | L: -0.03';
                    break;
                case 'split':
                    formula = 'H: -30° | C: ×0.75 | L: +0.10';
                    break;
                case 'contrast':
                    formula = 'Ensure 4.5:1 ratio | Opposite direction';
                    break;
                case 'custom':
                    formula = document.getElementById('rule-formula').value;
                    break;
            }

            // Add rule to rules tab
            const rulesContainer = document.getElementById('rules-tab');
            const ruleCard = document.createElement('div');
            ruleCard.className = 'rule-card';
            ruleCard.innerHTML = `
                <div class="rule-header">
                    <span class="rule-title">${source} → ${target}</span>
                    <span class="rule-type">${type}</span>
                </div>
                <div class="rule-formula">${formula}</div>
            `;

            const addButton = rulesContainer.querySelector('.top-btn');
            rulesContainer.insertBefore(ruleCard, addButton);

            closeRuleBuilder();
            alert('Rule created successfully!');
        };

        // Show/hide custom formula section
        document.getElementById('rule-type').addEventListener('change', (e) => {
            const customSection = document.getElementById('custom-formula-section');
            customSection.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });

        // Close modal when clicking outside
        document.getElementById('rule-builder-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeRuleBuilder();
            }
        });

        // ========== INITIALIZE ALL INTERACTIVE FEATURES ==========

        init2DPickers();
        initDragDrop();
        updateSafeZone();

        // Update safe zone whenever colors change
        const originalUpdateColors = updateColors;
        window.updateColors = function(group, component, value) {
            originalUpdateColors(group, component, value);
            updateSafeZone();
        };
    </script>
</body>
</html>
