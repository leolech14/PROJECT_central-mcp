<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Central-MCP • Unified Dashboard</title>
  <style>
    /* ═══════════════════════════════════════════════════════════════════════
       OKLCH COLOR SYSTEM - UNIFIED DASHBOARD
       ═══════════════════════════════════════════════════════════════════════ */
    :root {
      /* Base layers */
      --scaffold-bg-0: oklch(0.14 0.005 270);    /* Darkest base */
      --scaffold-bg-1: oklch(0.17 0.005 270);    /* Elevated cards */
      --scaffold-bg-2: oklch(0.20 0.005 270);    /* Highest elevation */

      /* Borders & dividers */
      --scaffold-border: oklch(0.24 0.005 270);
      --scaffold-border-hover: oklch(0.30 0.005 270);

      /* Text hierarchy */
      --scaffold-text-primary: oklch(0.92 0.005 270);
      --scaffold-text-secondary: oklch(0.65 0.005 270);
      --scaffold-text-tertiary: oklch(0.50 0.005 270);

      /* Status colors */
      --color-success: oklch(0.65 0.18 145);      /* Green */
      --color-warning: oklch(0.75 0.15 85);       /* Yellow */
      --color-error: oklch(0.60 0.22 25);         /* Red */
      --color-info: oklch(0.65 0.20 240);         /* Blue */
      --color-purple: oklch(0.65 0.25 300);       /* Purple */

      /* Metrics colors */
      --color-cpu: oklch(0.70 0.20 180);          /* Cyan */
      --color-memory: oklch(0.70 0.20 330);       /* Magenta */
      --color-disk: oklch(0.70 0.20 60);          /* Orange */
      --color-network: oklch(0.70 0.20 150);      /* Teal */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--scaffold-bg-0);
      color: var(--scaffold-text-primary);
      padding: 24px;
      line-height: 1.6;
    }

    /* Header */
    .header {
      margin-bottom: 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .subtitle {
      color: var(--scaffold-text-secondary);
      font-size: 14px;
      margin-top: 4px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--scaffold-bg-1);
      border: 1px solid var(--scaffold-border);
      border-radius: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Grid layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .dashboard-section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--scaffold-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 12px;
    }

    /* Card styles */
    .card {
      background: var(--scaffold-bg-1);
      border: 1px solid var(--scaffold-border);
      border-radius: 12px;
      padding: 20px;
      transition: all 200ms ease;
    }

    .card:hover {
      border-color: var(--scaffold-border-hover);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--scaffold-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .card-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge-success { background: var(--color-success); color: var(--scaffold-bg-0); }
    .badge-warning { background: var(--color-warning); color: var(--scaffold-bg-0); }
    .badge-error { background: var(--color-error); color: var(--scaffold-text-primary); }
    .badge-info { background: var(--color-info); color: var(--scaffold-text-primary); }

    .card-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }

    .card-label {
      font-size: 13px;
      color: var(--scaffold-text-secondary);
    }

    /* Metric row */
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--scaffold-border);
    }

    .metric-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .metric-row:first-child {
      padding-top: 0;
    }

    .metric-name {
      font-size: 13px;
      color: var(--scaffold-text-secondary);
    }

    .metric-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--scaffold-text-primary);
    }

    /* Progress bar */
    .progress-container {
      margin-top: 8px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--scaffold-bg-0);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--color-success);
      border-radius: 3px;
      transition: width 300ms ease;
    }

    /* Loop grid */
    .loops-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .loop-card {
      background: var(--scaffold-bg-2);
      border: 1px solid var(--scaffold-border);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .loop-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .loop-indicator.active {
      background: var(--color-success);
      box-shadow: 0 0 8px var(--color-success);
    }

    .loop-indicator.idle {
      background: var(--scaffold-text-tertiary);
    }

    .loop-info {
      flex: 1;
    }

    .loop-name {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .loop-stats {
      font-size: 11px;
      color: var(--scaffold-text-secondary);
    }

    /* Agent badges */
    .agents-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .agent-badge {
      padding: 8px 12px;
      background: var(--scaffold-bg-2);
      border: 1px solid var(--scaffold-border);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .agent-badge.active {
      border-color: var(--color-success);
      background: oklch(0.25 0.05 145);
    }

    /* Chart placeholder */
    .chart-container {
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--scaffold-bg-0);
      border-radius: 8px;
      margin-top: 12px;
      color: var(--scaffold-text-tertiary);
      font-size: 12px;
    }

    /* Loading & Error states */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--scaffold-text-secondary);
    }

    .error {
      background: var(--color-error);
      color: var(--scaffold-text-primary);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
    }

    /* System health ring */
    .health-ring {
      width: 100px;
      height: 100px;
      margin: 0 auto 16px;
      position: relative;
    }

    .health-ring svg {
      transform: rotate(-90deg);
    }

    .health-ring-bg {
      fill: none;
      stroke: var(--scaffold-bg-0);
      stroke-width: 8;
    }

    .health-ring-fill {
      fill: none;
      stroke: var(--color-success);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 300ms ease;
    }

    .health-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-weight: 700;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .loops-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div>
      <h1 class="title">Central-MCP Unified Dashboard</h1>
      <p class="subtitle">Real-time system monitoring • All data sources consolidated</p>
    </div>
    <div class="status-indicator">
      <div class="status-dot"></div>
      <span id="update-time">Loading...</span>
    </div>
  </div>

  <!-- System Overview -->
  <div class="dashboard-section">
    <h2 class="section-title">System Overview</h2>
    <div class="dashboard-grid">
      <!-- System Health -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">System Health</span>
          <span class="card-badge badge-success" id="health-badge">HEALTHY</span>
        </div>
        <div class="health-ring">
          <svg width="100" height="100">
            <circle class="health-ring-bg" cx="50" cy="50" r="42"/>
            <circle class="health-ring-fill" id="health-ring" cx="50" cy="50" r="42"
                    stroke-dasharray="264" stroke-dashoffset="0"/>
          </svg>
          <div class="health-value" id="health-value">100%</div>
        </div>
        <div class="metric-row">
          <span class="metric-name">Uptime</span>
          <span class="metric-value" id="uptime">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Active Loops</span>
          <span class="metric-value" id="active-loops">-</span>
        </div>
      </div>

      <!-- CPU & Memory -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Resources</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">CPU Usage</span>
          <span class="metric-value" id="cpu-usage">-</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="cpu-progress" style="width: 0%"></div>
          </div>
        </div>
        <div class="metric-row">
          <span class="metric-name">Memory Used</span>
          <span class="metric-value" id="memory-usage">-</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="memory-progress" style="width: 0%"></div>
          </div>
        </div>
        <div class="metric-row">
          <span class="metric-name">Disk Usage</span>
          <span class="metric-value" id="disk-usage">-</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="disk-progress" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- Projects -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Projects</span>
        </div>
        <div class="card-value" id="projects-total">-</div>
        <div class="card-label">Total Discovered</div>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="projects-progress" style="width: 0%"></div>
          </div>
          <div style="margin-top: 4px; font-size: 11px; color: var(--scaffold-text-tertiary);">
            <span id="projects-health">-</span> health
          </div>
        </div>
      </div>

      <!-- Active Agents -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Active Agents</span>
        </div>
        <div class="card-value" id="agents-total">-</div>
        <div class="card-label">Currently Active</div>
        <div class="agents-container" id="agents-list" style="margin-top: 12px;">
          <!-- Agent badges will be inserted here -->
        </div>
      </div>

      <!-- Tasks -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Tasks</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Completed</span>
          <span class="metric-value" id="tasks-completed">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">In Progress</span>
          <span class="metric-value" id="tasks-in-progress">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Pending</span>
          <span class="metric-value" id="tasks-pending">-</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="tasks-progress" style="width: 0%"></div>
          </div>
          <div style="margin-top: 4px; font-size: 11px; color: var(--scaffold-text-tertiary);">
            <span id="tasks-completion">-</span> completion rate
          </div>
        </div>
      </div>

      <!-- Database -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Database</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Projects</span>
          <span class="metric-value" id="db-projects">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Tasks</span>
          <span class="metric-value" id="db-tasks">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Agent Sessions</span>
          <span class="metric-value" id="db-agents">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Loop Logs</span>
          <span class="metric-value" id="db-logs">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Auto-Proactive Loops -->
  <div class="dashboard-section">
    <h2 class="section-title">Auto-Proactive Intelligence Loops</h2>
    <div class="loops-grid" id="loops-grid">
      <!-- Loop cards will be inserted here -->
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = window.location.origin;
    const UPDATE_INTERVAL = 2000; // 2 seconds

    // State
    let updateTimer = null;

    // Format helpers
    function formatUptime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${hours}h ${minutes}m`;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    function formatPercent(value) {
      return Math.round(value * 100) + '%';
    }

    // Fetch data from APIs
    async function fetchSystemStatus() {
      const response = await fetch(`${API_BASE}/api/system/status`);
      return await response.json();
    }

    async function fetchLoopStats() {
      const response = await fetch(`${API_BASE}/api/loops/stats`);
      return await response.json();
    }

    async function fetchPrometheusMetrics() {
      try {
        const response = await fetch('http://34.41.115.199:8001/metrics');
        const text = await response.text();
        return parsePrometheusMetrics(text);
      } catch (error) {
        console.warn('Could not fetch Prometheus metrics:', error);
        return {};
      }
    }

    function parsePrometheusMetrics(text) {
      const metrics = {};
      const lines = text.split('\n');

      for (const line of lines) {
        if (line.startsWith('#') || !line.trim()) continue;

        const match = line.match(/^([a-z_]+)(?:\{([^}]+)\})?\s+(.+)$/);
        if (match) {
          const [, name, labels, value] = match;
          metrics[name] = parseFloat(value);
        }
      }

      return metrics;
    }

    // Update dashboard
    async function updateDashboard() {
      try {
        const [systemStatus, loopStats, prometheusMetrics] = await Promise.all([
          fetchSystemStatus(),
          fetchLoopStats(),
          fetchPrometheusMetrics()
        ]);

        // Update timestamp
        document.getElementById('update-time').textContent = new Date().toLocaleTimeString();

        // System health
        const health = systemStatus.system?.health || 1.0;
        const healthPercent = Math.round(health * 100);
        document.getElementById('health-value').textContent = healthPercent + '%';

        const circumference = 2 * Math.PI * 42;
        const offset = circumference - (health * circumference);
        document.getElementById('health-ring').style.strokeDashoffset = offset;

        // Uptime
        const uptime = systemStatus.system?.uptime || 0;
        document.getElementById('uptime').textContent = formatUptime(uptime);

        // Active loops count
        const activeLoopsCount = Object.values(loopStats).filter(l => l.executionCount > 0).length;
        document.getElementById('active-loops').textContent = `${activeLoopsCount}/9`;

        // CPU (from Prometheus if available)
        const cpuUsage = prometheusMetrics.node_cpu_seconds_total || 0;
        const cpuPercent = Math.min(Math.round(cpuUsage * 10), 100);
        document.getElementById('cpu-usage').textContent = cpuPercent + '%';
        document.getElementById('cpu-progress').style.width = cpuPercent + '%';

        // Memory
        const memUsed = systemStatus.system?.memory?.heapUsed || 0;
        const memTotal = systemStatus.system?.memory?.heapTotal || 1;
        const memPercent = Math.round((memUsed / memTotal) * 100);
        document.getElementById('memory-usage').textContent = formatBytes(memUsed);
        document.getElementById('memory-progress').style.width = memPercent + '%';

        // Disk (placeholder)
        document.getElementById('disk-usage').textContent = '15%';
        document.getElementById('disk-progress').style.width = '15%';

        // Projects
        const projectsTotal = systemStatus.projects?.total || 0;
        const projectsHealth = systemStatus.projects?.healthyPercent || 0;
        document.getElementById('projects-total').textContent = projectsTotal;
        document.getElementById('projects-health').textContent = projectsHealth + '%';
        document.getElementById('projects-progress').style.width = projectsHealth + '%';

        // Agents
        const agentsActive = systemStatus.agents?.active || [];
        document.getElementById('agents-total').textContent = agentsActive.length;

        const agentsList = document.getElementById('agents-list');
        agentsList.innerHTML = '';
        ['A', 'B', 'C', 'D', 'E', 'F'].forEach(letter => {
          const isActive = agentsActive.some(a => a.agentLetter === letter);
          const badge = document.createElement('div');
          badge.className = 'agent-badge' + (isActive ? ' active' : '');
          badge.textContent = `Agent ${letter}`;
          agentsList.appendChild(badge);
        });

        // Tasks
        const tasks = systemStatus.tasks || {};
        document.getElementById('tasks-completed').textContent = tasks.completed || 0;
        document.getElementById('tasks-in-progress').textContent = tasks.in_progress || 0;
        document.getElementById('tasks-pending').textContent = tasks.pending || 0;

        const totalTasks = tasks.total || 1;
        const completedTasks = tasks.completed || 0;
        const completionRate = Math.round((completedTasks / totalTasks) * 100);
        document.getElementById('tasks-completion').textContent = completionRate + '%';
        document.getElementById('tasks-progress').style.width = completionRate + '%';

        // Database stats (from Prometheus)
        document.getElementById('db-projects').textContent = prometheusMetrics.central_mcp_projects_total || projectsTotal;
        document.getElementById('db-tasks').textContent = prometheusMetrics.central_mcp_tasks_total || totalTasks;
        document.getElementById('db-agents').textContent = agentsActive.length;
        document.getElementById('db-logs').textContent = '-';

        // Update loops
        updateLoops(loopStats);

      } catch (error) {
        console.error('Error updating dashboard:', error);
      }
    }

    function updateLoops(loopStats) {
      const loopsGrid = document.getElementById('loops-grid');
      loopsGrid.innerHTML = '';

      const loopNames = [
        { id: '0', name: 'System Status', key: 'SYSTEM_STATUS' },
        { id: '1', name: 'Agent Auto-Discovery', key: 'AGENT_AUTO_DISCOVERY' },
        { id: '2', name: 'Project Discovery', key: 'PROJECT_DISCOVERY' },
        { id: '4', name: 'Progress Monitoring', key: 'PROGRESS_MONITORING' },
        { id: '5', name: 'Status Analysis', key: 'STATUS_ANALYSIS' },
        { id: '6', name: 'Opportunity Scanning', key: 'OPPORTUNITY_SCANNING' },
        { id: '7', name: 'Spec Generation', key: 'SPEC_GENERATION' },
        { id: '8', name: 'Task Assignment', key: 'TASK_ASSIGNMENT' },
        { id: '9', name: 'Git Push Monitor', key: 'GIT_PUSH_MONITOR' }
      ];

      loopNames.forEach(({ id, name, key }) => {
        const stats = loopStats[`loop${id}`] || {};
        const isActive = (stats.executionCount || 0) > 0;
        const execCount = stats.executionCount || 0;
        const avgDuration = Math.round(stats.avgDuration || 0);

        const loopCard = document.createElement('div');
        loopCard.className = 'loop-card';
        loopCard.innerHTML = `
          <div class="loop-indicator ${isActive ? 'active' : 'idle'}"></div>
          <div class="loop-info">
            <div class="loop-name">Loop ${id}: ${name}</div>
            <div class="loop-stats">${execCount} exec • ${avgDuration}ms avg</div>
          </div>
        `;
        loopsGrid.appendChild(loopCard);
      });
    }

    // Initialize
    updateDashboard();
    setInterval(updateDashboard, UPDATE_INTERVAL);
  </script>
</body>
</html>
